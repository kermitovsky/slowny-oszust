<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Słowny Oszust</title>
<style>
  /* Twój styl tutaj albo jak wcześniej */
</style>
</head>
<body>
  <div id="loginScreen">
    <input type="text" id="playerName" placeholder="Twój nick (min. 3 znaki)" required />
    <button id="createRoom">Stwórz pokój</button>
    <input type="text" id="roomCodeInput" placeholder="Wpisz kod pokoju" />
    <button id="joinRoom">Dołącz</button>
    <p id="statusMessage" style="color:#666;"></p>
  </div>

  <div id="gameScreen" style="display:none;">
    <h2>Pokój: <span id="roomCodeDisplay"></span></h2>
    <ul id="playersList"></ul>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCyj5pbNgUHaV-_g__sTQmsUtYOhegYoSI",
    authDomain: "slowny-oszust.firebaseapp.com",
    databaseURL: "https://slowny-oszust-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "slowny-oszust",
    storageBucket: "slowny-oszust.firebasestorage.app",
    messagingSenderId: "679726628348",
    appId: "1:679726628348:web:83f9c43fee9cf514784679"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentRoomId = null;
  let currentPlayerId = null;
  let playersRef = null;

  const generateRoomCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
  const generatePlayerId = () => 'p_' + Math.random().toString(36).substring(2, 9);

  function setStatus(msg, isError=false) {
    const el = document.getElementById('statusMessage');
    el.textContent = msg;
    el.style.color = isError ? 'red' : '#666';
  }

  function setLoading(isLoading) {
    document.getElementById('createRoom').disabled = isLoading;
    document.getElementById('joinRoom').disabled = isLoading;
  }

  function showGameScreen(roomId) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    document.getElementById('roomCodeDisplay').textContent = roomId;
  }

  function updatePlayersList(players) {
    const list = document.getElementById('playersList');
    list.innerHTML = '';
    if (players) {
      Object.entries(players).forEach(([id, player]) => {
        const li = document.createElement('li');
        li.textContent = player.name;
        list.appendChild(li);
      });
    }
  }

  function initPlayersListener(roomId) {
    if (playersRef) playersRef.off();
    playersRef = db.ref(`rooms/${roomId}/players`);
    
    playersRef.on('value', snapshot => {
      const players = snapshot.val();
      updatePlayersList(players);

      // Jeśli nie ma graczy, usuń pokój
      if (!players || Object.keys(players).length === 0) {
        console.log(`Pokój ${roomId} jest pusty, usuwam...`);
        db.ref(`rooms/${roomId}`).remove();
        playersRef.off();
      }
    });
  }

  document.getElementById('createRoom').addEventListener('click', async () => {
    setStatus("");
    setLoading(true);
    try {
      const playerName = document.getElementById('playerName').value.trim();
      if (playerName.length < 3) throw new Error("Nick musi mieć minimum 3 znaki");

      const roomId = generateRoomCode();
      const playerId = generatePlayerId();

      await db.ref(`rooms/${roomId}`).set({
        players: {
          [playerId]: {
            name: playerName,
            isImpostor: false,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isHost: true
          }
        },
        status: "waiting",
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });

      currentRoomId = roomId;
      currentPlayerId = playerId;

      showGameScreen(roomId);
      initPlayersListener(roomId);
    } catch(e) {
      setStatus(e.message, true);
    }
    setLoading(false);
  });

  document.getElementById('joinRoom').addEventListener('click', async () => {
    setStatus("");
    setLoading(true);
    try {
      const roomId = document.getElementById('roomCodeInput').value.trim().toUpperCase();
      const playerName = document.getElementById('playerName').value.trim();

      if (roomId.length !== 4) throw new Error("Podaj poprawny 4-znakowy kod pokoju");
      if (playerName.length < 3) throw new Error("Nick musi mieć minimum 3 znaki");

      const roomSnapshot = await db.ref(`rooms/${roomId}`).once('value');
      if (!roomSnapshot.exists()) throw new Error("Pokój nie istnieje");

      const players = roomSnapshot.val().players || {};
      if (Object.values(players).some(p => p.name === playerName)) throw new Error("Ten nick jest zajęty");

      const playerId = generatePlayerId();
      await db.ref(`rooms/${roomId}/players/${playerId}`).set({
        name: playerName,
        isImpostor: false,
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        isHost: false
      });

      currentRoomId = roomId;
      currentPlayerId = playerId;

      showGameScreen(roomId);
      initPlayersListener(roomId);
    } catch(e) {
      setStatus(e.message, true);
    }
    setLoading(false);
  });

  window.addEventListener('beforeunload', () => {
    if (currentRoomId && currentPlayerId) {
      db.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).remove();
    }
    if (playersRef) playersRef.off();
  });

</script>
</body>
</html>
