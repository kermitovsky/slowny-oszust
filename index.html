<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gra wieloosobowa</title>
  <style>
    :root {
      --color-primary: #8e44ad; /* fiolet */
      --color-secondary: #e67e22; /* pomarańczowy */
      --color-primary-light: #a569bd;
      --color-secondary-light: #eb984e;
      --color-text: #ffffff; /* biały tekst dla lepszego kontrastu */
      --color-bg-container: #d35400; /* ciemniejszy pomarańcz */
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--color-secondary);
      margin: 0;
      padding: 20px;
      color: var(--color-text);
      font-size: 1.8rem;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: var(--color-bg-container);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 6px 10px rgba(142, 68, 173, 0.4);
    }

    h1 {
      font-family: 'Pacifico', cursive;
    }

    .fancy-title {
      font-family: 'Pacifico', cursive;
      font-size: 5.2rem;
      color: #fffbea;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
      animation: titlePop 0.8s ease-out;
      letter-spacing: 1.5px;
    }

    @keyframes titlePop {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    #loginScreen {
      text-align: center;
    }

    input {
      padding: 18px;
      margin: 12px 0;
      width: 80%;
      max-width: 350px;
      border: 3px solid var(--color-primary-light);
      border-radius: 12px;
      font-size: 2.4rem;
      transition: border-color 0.3s ease;
      background: #f9f3f0;
      color: #333;
    }

    input:focus {
      border-color: var(--color-primary);
      outline: none;
    }

    .buttons {
      margin-top: 35px;
    }

    button {
      padding: 18px 36px;
      background: var(--color-primary);
      color: var(--color-text);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 2.4rem;
      margin: 12px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 8px rgba(142, 68, 173, 0.6);
    }

    button:hover {
      background: var(--color-secondary-light);
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 6px 12px rgba(230, 126, 34, 0.7);
    }

    button:active {
      transform: translateY(0) scale(1);
    }

    .join-section {
      margin-top: 20px;
    }

    #gameScreen {
      margin-top: 40px;
      animation: fadeIn 0.6s ease;
      font-size: 2.4rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #playersList {
      list-style: none;
      padding: 0;
      margin: 30px 0;
    }

    #playersList li {
      padding: 16px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 400;
      color: var(--color-text);
    }

    #playersList li.host {
      color: var(--color-primary-light);
      font-weight: 700;
    }

    #playersList li.self {
      color: black;
      font-weight: 700;
      background: #f9f3f0cc;
    }

    #startGame {
      background: var(--color-secondary-light);
      margin-top: 30px;
      width: 100%;
      font-weight: 700;
      box-shadow: 0 5px 10px rgba(230, 126, 34, 0.6);
      color: #fff;
    }

    #startGame:hover {
      background: var(--color-primary);
      box-shadow: 0 7px 14px rgba(142, 68, 173, 0.7);
    }

    #endRoundBtn {
      background: #c0392b;
      margin-top: 30px;
      width: 100%;
      font-weight: 700;
      box-shadow: 0 5px 10px rgba(192, 57, 43, 0.6);
      color: #fff;
      border-radius: 12px;
    }

    #endRoundBtn:hover {
      background: #e74c3c;
      box-shadow: 0 7px 14px rgba(231, 76, 60, 0.7);
      cursor: pointer;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="fancy-title">Słowny Oszust</h1>
    <div id="loginScreen">
      <input type="text" id="playerName" placeholder="Twój nick" />
      <div class="join-section">
        <input type="text" id="roomCodeInput" placeholder="Kod pokoju (4 znaki)" maxlength="4" />
      </div>
      <div class="buttons">
        <button id="createRoom">Stwórz pokój</button>
        <button id="joinRoom">Dołącz do pokoju</button>
      </div>
      <p id="statusMessage"></p>
    </div>

    <div id="gameScreen" style="display:none;">
      <p>Jesteś w pokoju: <span id="roomCodeDisplay"></span></p>
      <ul id="playersList"></ul>
      <button id="endRoundBtn" style="display:none;">Zakończ rundę</button>
      <p id="gameStatusMessage" style="margin-top:20px; font-weight: 700;"></p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCyj5pbNgUHaV-_g__sTQmsUtYOhegYoSI",
        authDomain: "slowny-oszust.firebaseapp.com",
        databaseURL: "https://slowny-oszust-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "slowny-oszust",
        storageBucket: "slowny-oszust.firebasestorage.app",
        messagingSenderId: "679726628348",
        appId: "1:679726628348:web:83f9c43fee9cf514784679"
      };

      try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase zainicjalizowany");
      } catch (error) {
        console.error("Błąd inicjalizacji Firebase:", error);
        alert("Błąd połączenia z bazą danych!");
      }

      const db = firebase.database();
      let currentRoomId = null;
      let currentPlayerId = null;
      let playersRef = null;
      let statusRef = null;

      // Generatory kodów i id
      const generateRoomCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
      const generatePlayerId = () => 'p_' + Math.random().toString(36).substring(2, 9);

      // UI helpers
      function setStatus(message, isError = false) {
        const statusEl = document.getElementById('statusMessage');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.style.color = isError ? 'red' : '#666';
        }
      }

      function setGameStatus(message, isError = false) {
        const gameStatusEl = document.getElementById('gameStatusMessage');
        if (gameStatusEl) {
          gameStatusEl.textContent = message;
          gameStatusEl.style.color = isError ? 'red' : '#fff';
        }
      }

      function setLoading(isLoading) {
        const createBtn = document.getElementById('createRoom');
        const joinBtn = document.getElementById('joinRoom');
        if (createBtn) createBtn.disabled = isLoading;
        if (joinBtn) joinBtn.disabled = isLoading;
      }

      function showGameScreen(roomId) {
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');

        if (loginScreen) loginScreen.style.display = 'none';
        if (gameScreen) gameScreen.style.display = 'block';
        if (roomCodeDisplay) roomCodeDisplay.textContent = roomId;
      }

      function updatePlayersList(playersData) {
        const playersList = document.getElementById('playersList');
        if (!playersList) return;

        playersList.innerHTML = '';
        for (const playerId in playersData) {
          const player = playersData[playerId];
          const li = document.createElement('li');
          li.textContent = player.name + (player.isHost ? ' (host)' : '');

          if (playerId === currentPlayerId) {
            li.classList.add('self');
          }
          if (player.isHost) {
            li.classList.add('host');
          }

          playersList.appendChild(li);
        }
      }

      // Create room
      document.getElementById('createRoom').addEventListener('click', () => {
        const playerName = document.getElementById('playerName').value.trim();
        if (!playerName) {
          setStatus("Podaj swój nick!", true);
          return;
        }
        setStatus('');
        setLoading(true);

        let newRoomCode = generateRoomCode();

        // Sprawdź, czy kod jest wolny
        const roomRef = db.ref(`rooms/${newRoomCode}`);
        roomRef.get().then(snapshot => {
          if (snapshot.exists()) {
            // jeśli pokój istnieje, spróbuj ponownie (rzadka sytuacja)
            newRoomCode = generateRoomCode();
          }

          // Dodaj pokój z hostem
          const playerId = generatePlayerId();
          const roomData = {
            host: playerId,
            players: {
              [playerId]: {
                name: playerName,
                isHost: true,
                joinedAt: Date.now(),
              }
            },
            status: 'waiting',
          };

          roomRef.set(roomData).then(() => {
            currentRoomId = newRoomCode;
            currentPlayerId = playerId;
            setLoading(false);
            setStatus('');
            showGameScreen(currentRoomId);

            playersRef = db.ref(`rooms/${currentRoomId}/players`);
            statusRef = db.ref(`rooms/${currentRoomId}/status`);

            listenToRoomUpdates();

            setGameStatus('Czekasz na dołączenie innych graczy...');

            console.log(`Pokój ${currentRoomId} stworzony`);
          }).catch((error) => {
            setLoading(false);
            setStatus('Błąd podczas tworzenia pokoju. Spróbuj ponownie.', true);
            console.error(error);
          });
        }).catch((error) => {
          setLoading(false);
          setStatus('Błąd podczas sprawdzania pokoju. Spróbuj ponownie.', true);
          console.error(error);
        });
      });

      // Join room
      document.getElementById('joinRoom').addEventListener('click', () => {
        const playerName = document.getElementById('playerName').value.trim();
        const roomCodeInput = document.getElementById('roomCodeInput').value.trim().toUpperCase();
        if (!playerName) {
          setStatus("Podaj swój nick!", true);
          return;
        }
        if (!roomCodeInput || roomCodeInput.length !== 4) {
          setStatus("Wpisz poprawny kod pokoju (4 znaki).", true);
          return;
        }

        setStatus('');
        setLoading(true);

        const roomRef = db.ref(`rooms/${roomCodeInput}`);
        roomRef.get().then(snapshot => {
          if (!snapshot.exists()) {
            setLoading(false);
            setStatus("Pokój o podanym kodzie nie istnieje.", true);
            return;
          }

          const roomData = snapshot.val();
          if (roomData.status !== 'waiting') {
            setLoading(false);
            setStatus("Gra już się rozpoczęła lub zakończyła.", true);
            return;
          }

          // Dodaj nowego gracza
          const playerId = generatePlayerId();
          const newPlayer = {
            name: playerName,
            isHost: false,
            joinedAt: Date.now(),
          };

          db.ref(`rooms/${roomCodeInput}/players/${playerId}`).set(newPlayer).then(() => {
            currentRoomId = roomCodeInput;
            currentPlayerId = playerId;
            setLoading(false);
            setStatus('');
            showGameScreen(currentRoomId);

            playersRef = db.ref(`rooms/${currentRoomId}/players`);
            statusRef = db.ref(`rooms/${currentRoomId}/status`);

            listenToRoomUpdates();

            setGameStatus('Dołączono do pokoju. Czekaj na rozpoczęcie gry.');

            console.log(`Dołączono do pokoju ${currentRoomId}`);
          }).catch(error => {
            setLoading(false);
            setStatus('Błąd podczas dołączania do pokoju.', true);
            console.error(error);
          });
        }).catch(error => {
          setLoading(false);
          setStatus('Błąd podczas pobierania pokoju.', true);
          console.error(error);
        });
      });

      // Listen to room players and status changes
      function listenToRoomUpdates() {
        if (!currentRoomId) return;

        if (playersRef) {
          playersRef.on('value', (snapshot) => {
            const players = snapshot.val() || {};
            updatePlayersList(players);
            updateStartButtonVisibility(players);
          });
        }

        if (statusRef) {
          statusRef.on('value', (snapshot) => {
            const status = snapshot.val();
            handleGameStatusChange(status);
          });
        }
      }

      function updateStartButtonVisibility(players) {
        const startBtn = document.getElementById('startGame');
        if (!startBtn) {
          // jeśli przycisku jeszcze nie ma, dodajemy go tylko dla hosta
          const container = document.querySelector('#gameScreen');
          if (!container) return;

          const newStartBtn = document.createElement('button');
          newStartBtn.id = 'startGame';
          newStartBtn.textContent = 'Rozpocznij grę';
          newStartBtn.style.display = 'none';
          container.appendChild(newStartBtn);

          newStartBtn.addEventListener('click', () => {
            if (!currentRoomId) return;
            db.ref(`rooms/${currentRoomId}/status`).set('started');
            setGameStatus('Gra rozpoczęta!');
            newStartBtn.style.display = 'none';
          });
          return updateStartButtonVisibility(players);
        }

        // wyświetlamy przycisk startu tylko jeśli:
        // - gracz jest hostem
        // - jest co najmniej 2 graczy
        const playerIsHost = players[currentPlayerId]?.isHost;
        const enoughPlayers = Object.keys(players).length >= 2;
        if (playerIsHost && enoughPlayers) {
          startBtn.style.display = 'block';
        } else {
          startBtn.style.display = 'none';
        }
      }

      function handleGameStatusChange(status) {
        const endRoundBtn = document.getElementById('endRoundBtn');

        if (status === 'started') {
          setGameStatus('Gra trwa...');
          if (endRoundBtn) endRoundBtn.style.display = 'block';
        } else if (status === 'waiting') {
          setGameStatus('Czekasz na rozpoczęcie gry...');
          if (endRoundBtn) endRoundBtn.style.display = 'none';
        } else if (status === 'ended') {
          setGameStatus('Gra zakończona. Dziękujemy za grę!');
          if (endRoundBtn) endRoundBtn.style.display = 'none';
        } else {
          setGameStatus('');
          if (endRoundBtn) endRoundBtn.style.display = 'none';
        }
      }

      // End round button
      document.getElementById('endRoundBtn').addEventListener('click', () => {
        if (!currentRoomId) return;
        // tylko host może zakończyć rundę
        const playersSnapshot = playersRef.once('value');
        playersSnapshot.then(snapshot => {
          const players = snapshot.val() || {};
          if (!players[currentPlayerId]?.isHost) {
            alert('Tylko host może zakończyć rundę.');
            return;
          }
          db.ref(`rooms/${currentRoomId}/status`).set('ended');
        });
      });

    });
  </script>
</body>
</html>
