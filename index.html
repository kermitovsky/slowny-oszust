<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Słowny Oszust</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; background: #e67e22; color: white; padding: 2rem; }
    #gameScreen { display: none; }
    #startGame, #endRound, #leaveRoom { margin-top: 1rem; font-size: 1.5rem; padding: 0.7rem; }
    .host { font-weight: bold; color: #3498db; }
  </style>
</head>
<body>

<div id="loginScreen">
  <input id="playerName" placeholder="Nick" />
  <button id="createRoom">Stwórz pokój</button>
  <input id="roomCodeInput" placeholder="Kod pokoju" maxlength="4" />
  <button id="joinRoom">Dołącz do pokoju</button>
  <p id="statusMessage"></p>
</div>

<div id="gameScreen">
  <p>Kod pokoju: <span id="roomCodeDisplay"></span></p>
  <ul id="playersList"></ul>
  <button id="startGame" style="display:none;">Start gry</button>
  <button id="endRound" style="display:none;">Zakończ rundę</button>
  <button id="leaveRoom">Opuść pokój</button>
</div>

<div id="messageBox" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background: rgba(0,0,0,0.8); padding: 2rem; border-radius: 1rem; display:none; font-size:2rem;"></div>

<script>
  // Konfiguracja Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCyj5pbNgUHaV-_g__sTQmsUtYOhegYoSI",
    authDomain: "slowny-oszust.firebaseapp.com",
    databaseURL: "https://slowny-oszust-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "slowny-oszust",
    storageBucket: "slowny-oszust.appspot.com",
    messagingSenderId: "679726628348",
    appId: "1:679726628348:web:83f9c43fee9cf514784679"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const playerNameInput = document.getElementById('playerName');
  const createRoomBtn = document.getElementById('createRoom');
  const joinRoomBtn = document.getElementById('joinRoom');
  const roomCodeInput = document.getElementById('roomCodeInput');
  const statusMessage = document.getElementById('statusMessage');
  const loginScreen = document.getElementById('loginScreen');
  const gameScreen = document.getElementById('gameScreen');
  const roomCodeDisplay = document.getElementById('roomCodeDisplay');
  const playersList = document.getElementById('playersList');
  const startGameBtn = document.getElementById('startGame');
  const endRoundBtn = document.getElementById('endRound');
  const leaveRoomBtn = document.getElementById('leaveRoom');
  const messageBox = document.getElementById('messageBox');

  let currentRoomCode = null;
  let currentPlayerId = null;
  let currentPlayerName = null;
  let isHost = false;
  let words = [
    {innocent: "kot", impostor: "pies"},
    {innocent: "dom", impostor: "mieszkanie"},
    {innocent: "auto", impostor: "samochód"}
  ]; // Na potrzeby testu - zastąp fetchem jeśli chcesz

  function generateRoomCode() {
    return Math.random().toString(36).substring(2, 6).toUpperCase();
  }

  function showMessage(text, time=3000) {
    messageBox.textContent = text;
    messageBox.style.display = 'block';
    setTimeout(() => { messageBox.style.display = 'none'; }, time);
  }

  function updatePlayersList(players) {
    playersList.innerHTML = '';
    for (const [id, player] of Object.entries(players)) {
      const li = document.createElement('li');
      li.textContent = player.name + (player.isHost ? ' (host)' : '');
      if (id === currentPlayerId) li.style.fontWeight = 'bold';
      if (player.isHost) li.classList.add('host');
      playersList.appendChild(li);
    }
  }

  createRoomBtn.onclick = () => {
    const name = playerNameInput.value.trim();
    if (!name) return showMessage('Podaj nick!');
    currentPlayerName = name;
    isHost = true;
    currentRoomCode = generateRoomCode();
    currentPlayerId = db.ref().push().key;

    db.ref(`rooms/${currentRoomCode}`).set({
      players: {
        [currentPlayerId]: {name: currentPlayerName, isHost: true, role: null}
      },
      gameStarted: false
    }).then(() => {
      loginScreen.style.display = 'none';
      gameScreen.style.display = 'block';
      roomCodeDisplay.textContent = currentRoomCode;
      startGameBtn.style.display = 'inline-block';
      endRoundBtn.style.display = 'none';
      listenToRoom();
    });
  };

  joinRoomBtn.onclick = () => {
    const name = playerNameInput.value.trim();
    const code = roomCodeInput.value.trim().toUpperCase();
    if (!name) return showMessage('Podaj nick!');
    if (!code) return showMessage('Podaj kod pokoju!');

    currentPlayerName = name;
    currentRoomCode = code;
    currentPlayerId = db.ref().push().key;

    db.ref(`rooms/${currentRoomCode}/players`).once('value').then(snap => {
      if (!snap.exists()) {
        showMessage('Pokój nie istnieje');
        return;
      }
      const updates = {};
      updates[`rooms/${currentRoomCode}/players/${currentPlayerId}`] = {name: currentPlayerName, isHost: false, role: null};
      db.ref().update(updates).then(() => {
        loginScreen.style.display = 'none';
        gameScreen.style.display = 'block';
        roomCodeDisplay.textContent = currentRoomCode;
        startGameBtn.style.display = 'none';
        endRoundBtn.style.display = 'none';
        listenToRoom();
      });
    });
  };

  startGameBtn.onclick = () => {
    if (!isHost || !currentRoomCode) return;
    console.log("Start gry kliknięty przez hosta");

    const roomRef = db.ref(`rooms/${currentRoomCode}/players`);
    roomRef.once('value').then(snapshot => {
      const players = snapshot.val();
      if (!players) return showMessage('Brak graczy w pokoju.');
      const playerIds = Object.keys(players);
      if (playerIds.length < 3) return showMessage('Minimum 3 graczy aby zacząć.');

      // Wylosuj impostora i słowa
      const impostorIndex = Math.floor(Math.random() * playerIds.length);
      const impostorId = playerIds[impostorIndex];
      const wordIndex = Math.floor(Math.random() * words.length);
      const innocentWord = words[wordIndex].innocent;
      const impostorWord = words[wordIndex].impostor;

      const updates = {};
      playerIds.forEach(id => {
        updates[`${id}/role`] = (id === impostorId) ? 'impostor' : 'innocent';
        updates[`${id}/word`] = (id === impostorId) ? impostorWord : innocentWord;
      });

      db.ref(`rooms/${currentRoomCode}/players`).update(updates)
        .then(() => {
          db.ref(`rooms/${currentRoomCode}`).update({gameStarted: true});
          showMessage('Gra rozpoczęta!', 2000);
        })
        .catch(e => {
          console.error("Błąd update ról i słów", e);
          showMessage('Błąd podczas startu gry.');
        });
    });
  };

  endRoundBtn.onclick = () => {
    if (!currentRoomCode) return;
    const playersRef = db.ref(`rooms/${currentRoomCode}/players`);
    playersRef.once('value').then(snap => {
      const players = snap.val();
      if (!players) return;

      const updates = {};
      Object.keys(players).forEach(id => {
        updates[`${id}/role`] = null;
        updates[`${id}/word`] = null;
      });
      playersRef.update(updates).then(() => {
        db.ref(`rooms/${currentRoomCode}`).update({gameStarted: false});
        startGameBtn.style.display = isHost ? 'inline-block' : 'none';
        endRoundBtn.style.display = 'none';
        showMessage("Wrócono do lobby", 2000);
      });
    });
  };

  leaveRoomBtn.onclick = leaveRoom;

  async function leaveRoom() {
    if (!currentRoomCode || !currentPlayerId) return;
    const roomRef = db.ref(`rooms/${currentRoomCode}`);

    const snapshot = await roomRef.once('value');
    if (!snapshot.exists()) return;

    const roomData = snapshot.val();
    if (!roomData.players) return;

    const players = {...roomData.players};
    const leavingIsHost = players[currentPlayerId]?.isHost === true;

    delete players[currentPlayerId];

    if (Object.keys(players).length === 0) {
      await roomRef.remove();
      resetAfterLeaving();
      return;
    }

    if (leavingIsHost) {
      const sortedIds = Object.keys(players).sort();
      const newHostId = sortedIds[0];
      Object.values(players).forEach(p => p.isHost = false);
      players[newHostId].isHost = true;
    }

    await roomRef.child('players').set(players);
    resetAfterLeaving();
  }

  function resetAfterLeaving() {
    loginScreen.style.display = 'block';
    gameScreen.style.display = 'none';
    statusMessage.textContent = '';
    currentRoomCode = null;
    currentPlayerId = null;
    currentPlayerName = null;
    isHost = false;
    startGameBtn.style.display = 'none';
    endRoundBtn.style.display = 'none';
  }

  function listenToRoom() {
    if (!currentRoomCode) return;
    const roomRef = db.ref(`rooms/${currentRoomCode}`);

    roomRef.on('value', snapshot => {
      if (!snapshot.exists()) {
        showMessage('Pokój został zamknięty');
        resetAfterLeaving();
        return;
      }

      const roomData = snapshot.val();
      if (!roomData.players) return;

      updatePlayersList(roomData.players);

      // Sprawdź hosta i czy ja hostem
      let foundHost = false;
      for (const [id, player] of Object.entries(roomData.players)) {
        if (player.isHost) {
          foundHost = true;
          isHost = (id === currentPlayerId);
          break;
        }
      }
      if (!foundHost) {
        isHost = false;
      }

      // Pokaż/ukryj przyciski startu i zakończenia rundy
      startGameBtn.style.display = (isHost && !roomData.gameStarted) ? 'inline-block' : 'none';
      endRoundBtn.style.display = (isHost && roomData.gameStarted) ? 'inline-block' : 'none';

      // Komunikaty ról gracza
      if (roomData.gameStarted) {
        const me = roomData.players[currentPlayerId];
        if (!me) return;
        if (me.role === 'impostor') {
          showMessage("Jesteś oszustem!", 7000);
        } else if (me.role === 'innocent') {
          showMessage(`Twoje słowo to: ${me.word}`, 7000);
        }
      }
    });
  }

  window.addEventListener('beforeunload', () => {
    // Nie zawsze zadziała, ale próbujemy
    if (currentRoomCode && currentPlayerId) {
      leaveRoom();
    }
  });
</script>

</body>
</html>
