<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gra słowny oszust</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #2c3e50;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #3498db;
      text-align: center;
      margin-bottom: 25px;
    }
    #loginScreen {
      text-align: center;
    }
    input {
      padding: 12px;
      margin: 8px 0;
      width: 80%;
      max-width: 300px;
      border: 2px solid #dfe6e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }
    input:focus {
      border-color: #3498db;
      outline: none;
    }
    .buttons {
      margin-top: 25px;
    }
    button {
      padding: 12px 24px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 8px;
      transition: all 0.3s;
    }
    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }
    .join-section {
      margin-top: 20px;
    }
    #gameScreen {
      margin-top: 30px;
      animation: fadeIn 0.5s;
      display: none;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #playersList {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    #playersList li {
      padding: 12px;
      margin: 8px 0;
      background: #ecf0f1;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #playersList li.impostor {
      background: #ffebee;
      color: #e74c3c;
      font-weight: bold;
    }
    #startGame {
      background: #2ecc71;
      margin-top: 20px;
      width: 100%;
    }
    #startGame:hover {
      background: #27ae60;
    }
    #statusMessage {
      margin-top: 15px;
      height: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gra słowny oszust</h1>
    <div id="loginScreen">
      <input id="playerName" type="text" placeholder="Twój nick" autocomplete="off" />
      <div class="buttons">
        <button id="createRoom">Utwórz pokój</button>
      </div>
      <div class="join-section">
        <input id="roomCodeInput" type="text" maxlength="4" placeholder="Kod pokoju" autocomplete="off" />
        <div class="buttons">
          <button id="joinRoom">Dołącz do pokoju</button>
        </div>
      </div>
      <div id="statusMessage"></div>
    </div>

    <div id="gameScreen">
      <h2>Pokój: <span id="roomCodeDisplay"></span></h2>
      <ul id="playersList"></ul>
      <!-- Możesz dodać tu przycisk startu gry lub inne elementy -->
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Inicjalizacja Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCyj5pbNgUHaV-_g__sTQmsUtYOhegYoSI",
        authDomain: "slowny-oszust.firebaseapp.com",
        databaseURL: "https://slowny-oszust-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "slowny-oszust",
        storageBucket: "slowny-oszust.firebasestorage.app",
        messagingSenderId: "679726628348",
        appId: "1:679726628348:web:83f9c43fee9cf514784679"
      };

      try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase zainicjalizowany");
      } catch (error) {
        console.error("Błąd inicjalizacji Firebase:", error);
        alert("Błąd połączenia z bazą danych!");
      }

      const db = firebase.database();
      let currentRoomId = null;
      let currentPlayerId = null;
      let playersRef = null;

      // Generowanie ID
      const generateRoomCode = () => Math.random().toString(36).substring(2, 6).toUpperCase();
      const generatePlayerId = () => 'p_' + Math.random().toString(36).substring(2, 9);

      // UI Helpers
      function setStatus(message, isError = false) {
        const statusEl = document.getElementById('statusMessage');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.style.color = isError ? 'red' : '#666';
        }
      }

      function setLoading(isLoading) {
        const createBtn = document.getElementById('createRoom');
        const joinBtn = document.getElementById('joinRoom');
        if (createBtn) createBtn.disabled = isLoading;
        if (joinBtn) joinBtn.disabled = isLoading;
      }

      function showGameScreen(roomId) {
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        
        if (loginScreen) loginScreen.style.display = 'none';
        if (gameScreen) gameScreen.style.display = 'block';
        if (roomCodeDisplay) roomCodeDisplay.textContent = roomId;
      }

      function updatePlayersList(players, myPlayerId) {
        const playersList = document.getElementById('playersList');
        if (!playersList) {
          console.error("Element playersList nie istnieje!");
          return;
        }
        
        playersList.innerHTML = '';
        
        if (players) {
          Object.entries(players).forEach(([id, player]) => {
            const li = document.createElement('li');
            li.textContent = player.name;

            // Pogrub nick aktualnego gracza
            if (id === myPlayerId) {
              li.style.fontWeight = 'bold';
            }

            if (player.isHost) {
              li.innerHTML += ' <span style="color:#4285f4">(host)</span>';
            }
            playersList.appendChild(li);
          });
        }
      }

      function initPlayersListener(roomId) {
        if (playersRef) {
          playersRef.off();
        }

        playersRef = db.ref(`rooms/${roomId}/players`);
        
        playersRef.on('value', (snapshot) => {
          updatePlayersList(snapshot.val(), currentPlayerId);
        });
        
        playersRef.once('value').then(snapshot => {
          updatePlayersList(snapshot.val(), currentPlayerId);
        });
      }

      // Tworzenie pokoju
      document.getElementById('createRoom').addEventListener('click', async function() {
        try {
          setLoading(true);
          const playerName = document.getElementById('playerName').value.trim();
          
          if (playerName.length < 3) {
            setStatus("Nick musi mieć minimum 3 znaki!", true);
            setLoading(false);
            return;
          }
          
          const roomId = generateRoomCode();
          const playerId = generatePlayerId();
          
          await db.ref(`rooms/${roomId}`).set({
            players: {
              [playerId]: {
                name: playerName,
                isImpostor: false,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                isHost: true
              }
            },
            status: "waiting",
            createdAt: firebase.database.ServerValue.TIMESTAMP
          });

          currentRoomId = roomId;
          currentPlayerId = playerId;

          showGameScreen(roomId);
          initPlayersListener(roomId);
          setStatus("");
          
        } catch (error) {
          console.error("Błąd tworzenia pokoju:", error);
          setStatus("Błąd: " + error.message, true);
        } finally {
          setLoading(false);
        }
      });

      // Dołączanie do pokoju
      document.getElementById('joinRoom').addEventListener('click', async function() {
        try {
          setLoading(true);
          setStatus("Łączenie...");
          
          const roomId = document.getElementById('roomCodeInput').value.trim().toUpperCase();
          const playerName = document.getElementById('playerName').value.trim();

          if (!roomId || roomId.length !== 4) {
            throw new Error("Podaj poprawny 4-znakowy kod pokoju");
          }
          if (!playerName || playerName.length < 3) {
            throw new Error("Nick musi mieć minimum 3 znaki");
          }

          const roomSnapshot = await db.ref(`rooms/${roomId}`).once('value');
          if (!roomSnapshot.exists()) {
            throw new Error("Pokój nie istnieje!");
          }

          const players = roomSnapshot.val().players || {};
          const nickExists = Object.values(players).some(p => p.name === playerName);
          if (nickExists) {
            throw new Error("Ten nick jest już zajęty!");
          }

          const playerId = generatePlayerId();
          await db.ref(`rooms/${roomId}/players/${playerId}`).set({
            name: playerName,
            isImpostor: false,
            joinedAt: firebase.database.ServerValue.TIMESTAMP,
            isHost: false
          });

          currentRoomId = roomId;
          currentPlayerId = playerId;

          showGameScreen(roomId);
          setStatus("");
          initPlayersListener(roomId);
          
        } catch (error) {
          console.error("Błąd dołączania:", error);
          setStatus(error.message, true);
        } finally {
          setLoading(false);
        }
      });

      // Czyszczenie danych przy zamknięciu
      window.addEventListener('beforeunload', () => {
        if (currentRoomId && currentPlayerId) {
          db.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`).remove();
        }
        if (playersRef) {
          playersRef.off();
        }
      });

      // Automatyczne ukrywanie komunikatów
      const playerNameInput = document.getElementById('playerName');
      const roomCodeInput = document.getElementById('roomCodeInput');

      if (playerNameInput) {
        playerNameInput.addEventListener('input', () => setStatus(""));
      }
      if (roomCodeInput) {
        roomCodeInput.addEventListener('input', () => setStatus(""));
      }
    });
  </script>
</body>
</html>
